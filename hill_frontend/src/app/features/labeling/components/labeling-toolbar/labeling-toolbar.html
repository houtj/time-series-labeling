<div class="labeling-toolbar">

  <!-- Toggle Buttons Section -->
  <div class="toolbar-section toggle-buttons">
    <p-button
      [icon]="labelToggleButton ? 'pi pi-tag' : 'pi pi-tag'"
      (onClick)="onChangeLabelToggle($event)"
      [rounded]="true"
      [text]="!labelToggleButton"
      [raised]="labelToggleButton"
      [severity]="labelToggleButton ? 'primary' : undefined"
      pTooltip="Label Mode: Click twice to define an event (Shortcut: E)"
      tooltipPosition="right"
    />
    <p-button
      [icon]="guidelineToggleButton ? 'pi pi-minus' : 'pi pi-minus'"
      (onClick)="onChangeGuidelineToggle($event)"
      [rounded]="true"
      [text]="!guidelineToggleButton"
      [raised]="guidelineToggleButton"
      [severity]="guidelineToggleButton ? 'primary' : undefined"
      pTooltip="Guideline Mode: Click to create a horizontal line (Shortcut: G)"
      tooltipPosition="right"
    />
  </div>
  
  <!-- File Actions Section -->
  <div class="toolbar-section file-actions">
    <p-button 
      icon="pi pi-share-alt" 
      (onClick)="onClickShare()" 
      [rounded]="true" 
      [text]="true"
      pTooltip="Share Folder"
      tooltipPosition="bottom"
    />
    <p-button 
      icon="pi pi-file-import" 
      (onClick)="onClickImport()" 
      [rounded]="true" 
      [text]="true"
      pTooltip="Import Labels"
      tooltipPosition="bottom"
    />
    <input 
      id="fileImportInput" 
      type="file" 
      (change)="onChangeImportInput($event)" 
      style="display: none;" 
      accept=".json" 
      [multiple]="false"
    />
    <p-button 
      icon="pi pi-file-export" 
      (onClick)="onClickExport()" 
      [rounded]="true" 
      [text]="true"
      pTooltip="Export Labels"
      tooltipPosition="bottom"
    />
    <p-button 
      icon="pi pi-download" 
      (onClick)="onClickDownload()" 
      [rounded]="true" 
      [text]="true"
      pTooltip="Download Data"
      tooltipPosition="bottom"
    />
  </div>

  <!-- Navigation Section -->
  <div class="toolbar-section navigation">
    <p-button 
      icon="pi pi-arrow-up" 
      (onClick)="onClickBack()" 
      [rounded]="true" 
      [text]="true"
      pTooltip="Back to Files"
      tooltipPosition="bottom"
    />
    <p-button 
      icon="pi pi-chevron-left" 
      (onClick)="onClickPreviousFile()" 
      [rounded]="true" 
      [text]="true"
      pTooltip="Previous File"
      tooltipPosition="bottom"
    />
    <p-button 
      icon="pi pi-chevron-right" 
      (onClick)="onClickNextFile()" 
      [rounded]="true" 
      [text]="true"
      pTooltip="Next File"
      tooltipPosition="bottom"
    />
    <p-button 
      icon="pi pi-pencil" 
      (onClick)="onClickEditFileDescription()" 
      [rounded]="true" 
      [text]="true"
      pTooltip="Edit File Description"
      tooltipPosition="bottom"
    />
  </div>
  
  
  <!-- AI/Agent Actions Section -->
  <div class="toolbar-section ai-actions">
    <p-button 
      icon="pi pi-comments" 
      (onClick)="onClickToggleAiChat()" 
      [rounded]="true" 
      [text]="true"
      pTooltip="AI Assistant"
      tooltipPosition="bottom"
    />
    <p-button 
      icon="pi pi-file-edit" 
      (onClick)="onClickEditDescriptions()" 
      [rounded]="true" 
      [text]="true"
      pTooltip="Edit Class Descriptions"
      tooltipPosition="bottom"
    />
    <p-button 
      icon="pi pi-cog" 
      (onClick)="onClickAutoAnnotate()" 
      [rounded]="true" 
      [text]="true"
      [loading]="isAutoAnnotationRunning()"
      pTooltip="Auto-Annotation Agent"
      tooltipPosition="bottom"
    />
  </div>
</div>

<!-- Label Selection Dialog -->
<p-dialog
  [closable]="false"
  [modal]="true"
  [(visible)]="labelSelectionDialogVisible"
  [style]="{width: '50vw'}"
  header="Select Event Class">
  <div class="dialog-body">
    <div class="dialog-content">
      <label for="eventClass">Select a Class</label>
      <p-select
        inputId="eventClass"
        [options]="classList"
        [(ngModel)]="selectedClass"
        (onChange)="onClassSelectionChange()"
        optionLabel="name"
        placeholder="Select a class"
        appendTo="body"
        [style]="{width: '100%'}"
      />
      
      @if (isAddingNewClass) {
        <label for="newClassName">New Class Name</label>
        <input 
          id="newClassName" 
          type="text" 
          pInputText 
          [(ngModel)]="newClassName"
          placeholder="Enter new class name"
          [style]="{width: '100%'}"
          autofocus
        />
      }
      
      <label for="eventDescription">Description</label>
      <input 
        id="eventDescription" 
        type="text" 
        pInputText 
        [(ngModel)]="selectedEventDescription"
        placeholder="Add a description for this event"
        [style]="{width: '100%'}"
      />
      
      <!-- Window Features Section -->
      <div class="window-features-section">
        <h4>Window Features</h4>
        
        @if (featuresLoading()) {
          <div class="features-loading">
            <i class="pi pi-spin pi-spinner"></i>
            <span>Computing features...</span>
          </div>
        } @else if (windowFeatures()) {
          <div class="features-content">
            @for (channel of windowFeatures()!.frequency | keyvalue; track channel.key) {
              <div class="channel-features">
                <h5>{{ channel.key }}</h5>
                
                <!-- Frequency Features -->
                <div class="feature-category">
                  <strong>Frequency:</strong>
                  <div class="feature-grid">
                    <span>Delta: {{ windowFeatures()!.frequency[channel.key].bp_delta | number:'1.2-4' }}</span>
                    <span>Theta: {{ windowFeatures()!.frequency[channel.key].bp_theta | number:'1.2-4' }}</span>
                    <span>Alpha: {{ windowFeatures()!.frequency[channel.key].bp_alpha | number:'1.2-4' }}</span>
                    <span>Beta: {{ windowFeatures()!.frequency[channel.key].bp_beta | number:'1.2-4' }}</span>
                    <span>Slow Ratio: {{ windowFeatures()!.frequency[channel.key].slow_ratio | number:'1.2-4' }}</span>
                    <span>Fast Ratio: {{ windowFeatures()!.frequency[channel.key].fast_ratio | number:'1.2-4' }}</span>
                  </div>
                </div>
                
                <!-- Energy Features -->
                <div class="feature-category">
                  <strong>Energy:</strong>
                  <div class="feature-grid">
                    <span>RMS: {{ windowFeatures()!.energy[channel.key].rms | number:'1.2-4' }}</span>
                    <span>Mean Env: {{ windowFeatures()!.energy[channel.key].mean_envelope | number:'1.2-4' }}</span>
                    <span>Std Env: {{ windowFeatures()!.energy[channel.key].std_envelope | number:'1.2-4' }}</span>
                    <span>Max Env: {{ windowFeatures()!.energy[channel.key].max_envelope | number:'1.2-4' }}</span>
                  </div>
                </div>
                
                <!-- Morphology Features -->
                <div class="feature-category">
                  <strong>Morphology:</strong>
                  <div class="feature-grid">
                    <span>Peak-to-Peak: {{ windowFeatures()!.morphology[channel.key].peak_to_peak | number:'1.2-4' }}</span>
                    <span>Zero Cross Rate: {{ windowFeatures()!.morphology[channel.key].zero_crossing_rate | number:'1.2-4' }}</span>
                    <span>Max Slope: {{ windowFeatures()!.morphology[channel.key].max_slope | number:'1.2-4' }}</span>
                    <span>Symmetry: {{ windowFeatures()!.morphology[channel.key].symmetry_estimate | number:'1.2-4' }}</span>
                  </div>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="features-error">
            <i class="pi pi-exclamation-triangle"></i>
            <span>Failed to compute features</span>
          </div>
        }
      </div>
    </div>
    <div class="dialog-buttons">
      <p-button 
        icon="pi pi-check" 
        (onClick)="onClickSelectClass()" 
        [rounded]="true" 
        [text]="true"
        [label]="isAddingNewClass ? 'Create & Add Event' : 'OK'"
      />
      <p-button 
        icon="pi pi-times" 
        (onClick)="onClickDialogCancel('label')" 
        [rounded]="true" 
        [text]="true"
        label="Cancel"
      />
    </div>
  </div>
</p-dialog>

<!-- Guideline Selection Dialog -->
<p-dialog
  [closable]="false"
  [modal]="true"
  [(visible)]="guidelineSelectionDialogVisible"
  [style]="{width: '50vw'}"
  header="Select Channel for Guideline">
  <div class="dialog-body">
    <div class="dialog-content">
      <label for="channelSelect">Select a Channel</label>
      <p-select
        inputId="channelSelect"
        [options]="channelList"
        [(ngModel)]="selectedYAxis"
        optionLabel="channelName"
        placeholder="Select a channel"
        appendTo="body"
        [style]="{width: '100%'}"
      />
    </div>
    <div class="dialog-buttons">
      <p-button 
        icon="pi pi-check" 
        (onClick)="onClickSelectChannel()" 
        [rounded]="true" 
        [text]="true"
        label="OK"
      />
      <p-button 
        icon="pi pi-times" 
        (onClick)="onClickDialogCancel('guideline')" 
        [rounded]="true" 
        [text]="true"
        label="Cancel"
      />
    </div>
  </div>
</p-dialog>

<!-- File Description Edit Dialog -->
<app-description-dialog
  [(visible)]="fileDescriptionDialogVisible"
  [(description)]="fileDescriptionText"
  [title]="'Edit File Description'"
  [resourceName]="fileInfo?.name || ''"
  [placeholder]="'Enter file description...'"
  [maxLength]="500"
  [rows]="3"
  (onSave)="onSaveFileDescription($event)"
/>
