<div class="labeling-page">
  <!-- Labeling Toolbar -->
  <app-labeling-toolbar 
    [fileId]="fileId"
    [folderId]="folderId"
    [fileInfo]="fileInfo"
    [folderInfo]="folderInfo"
    [labelInfo]="labelInfo"
    [projectInfo]="projectInfo()"
    (onShare)="onShareFolder()"
    (onImport)="onImportLabels()"
    (onExport)="onExportLabels()"
    (onDownload)="onDownloadData()"
    (onEditDescriptions)="onEditDescriptions()"
    (onAutoAnnotate)="onAutoAnnotate()"
    (onToggleAiChat)="onToggleAiChat()"
  />
  
  <!-- Main Splitter: Chart + Panels -->
  <p-splitter 
    [style]="{ height: '100%', width:'100%'}" 
    layout="vertical" 
    class="splitter-area" 
    (onResizeEnd)="onResizePlot()"
  >
    <!-- Chart Area -->
    <ng-template pTemplate>
      <div class="chart-area">
        <app-chart 
          [data]="data"
          [labelInfo]="labelInfo"
        />
      </div>
    </ng-template>
    <!-- Bottom Panels Area -->
    <ng-template pTemplate>
      <div class="panels-area">
        @if (labelInfo) {
          <div class="panels-container">
            <!-- Left Side: Guidelines Tab (with optional AI/Agent tabs) -->
            <div class="left-tabs">
              <div class="tabs-with-actions">
                <p-tabs [(value)]="activeTab">
                  <p-tablist>
                    <p-tab value="0">
                      <i class="pi pi-list"></i>
                      <span>Guidelines</span>
                    </p-tab>
                    @if (aiChatVisible) {
                      <p-tab value="1">
                        <i class="pi pi-comments"></i>
                        <span>AI Assistant</span>
                      </p-tab>
                    }
                    @if (autoDetectionVisible) {
                      <p-tab [value]="aiChatVisible ? '2' : '1'">
                        <i class="pi pi-cog"></i>
                        <span>Auto-Detection</span>
                      </p-tab>
                    }
                  </p-tablist>
                  <p-tabpanels>
                    <p-tabpanel value="0">
                      <app-guidelines-panel 
                        [labelInfo]="labelInfo"
                        (onRefresh)="onRefreshPage()"
                      />
                    </p-tabpanel>
                    @if (aiChatVisible) {
                      <p-tabpanel value="1">
                        <app-ai-chat-tab [fileId]="fileId" (onClose)="onAiChatClose()" />
                      </p-tabpanel>
                    }
                    @if (autoDetectionVisible) {
                      <p-tabpanel [value]="aiChatVisible ? '2' : '1'">
                        <app-auto-detection-panel 
                          [fileId]="fileId"
                          [folderId]="folderId"
                          [projectId]="projectInfo()?._id?.$oid"
                          (onClose)="onAutoDetectionClose()"
                        />
                      </p-tabpanel>
                    }
                  </p-tabpanels>
                </p-tabs>
                <div class="tab-actions">
                  @for (action of getLeftToolbarActions(); track action.icon) {
                    <p-button 
                      [icon]="action.icon"
                      [severity]="action.severity || 'secondary'"
                      [pTooltip]="action.label"
                      tooltipPosition="bottom"
                      (onClick)="action.action($event)"
                      [disabled]="action.disabled"
                      [rounded]="true"
                      [text]="true"
                    />
                  }
                </div>
              </div>
            </div>

            <!-- Right Side: Events Tabs -->
            <div class="right-tabs">
              <div class="tabs-with-actions">
                <p-tabs value="0">
                  <p-tablist>
                    <p-tab value="0">
                      <i class="pi pi-calendar"></i>
                      <span>Events</span>
                    </p-tab>
                  </p-tablist>
                  <p-tabpanels>
                    <p-tabpanel value="0">
                      <app-events-panel 
                        [labelInfo]="labelInfo"
                        (onRefresh)="onRefreshPage()"
                        (onEditDescription)="onEditEventDescription($event)"
                      />
                    </p-tabpanel>
                  </p-tabpanels>
                </p-tabs>
                <div class="tab-actions">
                  @for (action of getRightToolbarActions(); track action.icon) {
                    <p-button 
                      [icon]="action.icon"
                      [severity]="action.severity || 'secondary'"
                      [pTooltip]="action.label"
                      tooltipPosition="bottom"
                      (onClick)="action.action($event)"
                      [disabled]="action.disabled"
                      [rounded]="true"
                      [text]="true"
                    />
                  }
                </div>
              </div>
            </div>
          </div>
        } @else {
          <div class="empty-state">
            <i class="pi pi-info-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
            <p>No label data available</p>
          </div>
        }
      </div>
    </ng-template>
  </p-splitter>
</div>

<!-- Share Dialog -->
<app-share-dialog
  [(visible)]="shareDialogVisible"
  [title]="'Share Folder'"
  [resourceType]="'folder'"
  [resourceName]="folderInfo?.name || ''"
  (onShare)="onShareFolderConfirm($event)"
/>

<!-- Description Dialog -->
<app-description-dialog
  [(visible)]="descriptionDialogVisible"
  [title]="'Edit Event Description'"
  [resourceName]="selectedEvent?.className || ''"
  [description]="selectedEventDescription"
  [placeholder]="'Add notes about this event...'"
  [maxLength]="500"
  [rows]="5"
  (onSave)="onSaveEventDescription($event)"
/>

<!-- Project Descriptions Dialog -->
<app-project-descriptions-dialog
  [(visible)]="projectDescriptionsDialogVisible"
  [projectId]="projectInfo()?._id?.$oid"
  [projectName]="projectInfo()?.projectName || ''"
  [classes]="projectInfo()?.classes || []"
  [generalDescription]="projectInfo()?.general_pattern_description || ''"
  (onSave)="onProjectDescriptionsSave()"
/>

<!-- Download Dialog -->
<p-dialog
  header="Download"
  [closable]="true"
  [modal]="true"
  [(visible)]="downloadDialogVisible"
  [style]="{width: '50vw'}">
  <div class="dialog-body">
    <div class="dialog-content">
      <a 
        title="Download JSON" 
        [href]="downloadUri" 
        download="download.json" 
        (click)="downloadDialogVisible = false">
        Download JSON File
      </a>
    </div>
  </div>
</p-dialog>

<!-- Toast for notifications -->
<p-toast />
